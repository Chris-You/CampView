@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}

<style type="text/css">

	.non-visiable {
		display: none;
	}

	.alert {
		margin-bottom:10px;
		border-radius:0px;
	}

</style>
   
<script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=ak5szsi1xk&callback=mapSet"></script>

<script>

    var map;
    var markers=[];
    var infoWindows = [];
    var dataList = [];


    function mapInit() {

        map = null;
        markers=[];
        infoWindows = [];
        dataList = [];

        navigator.geolocation.getCurrentPosition(function (position) {
                setMap(position.coords.latitude, position.coords.longitude);
            }
            , function (error) {
                console.log(error);
            });
	}


    function mapSet() {

        if(!navigator.geolocation) {
            alert('Geolocation is not supported by your browser');
        }
        else
        {
            mapInit();

            var data = "";
            if ($("#search").val() != "") {
                data="search=" + $("#search").val()
			}

            //$("#divCampList").empty();
            var list = "";

            $.ajax({
                type: "post",
                url: "/home/Search",
                data: data,
                success: function (data) {
                    //script = data.replace(/<script>(.*)<\/script>/, "$1"); // Remove tags
                    //eval(script); // Execute javascript
                    if (data.response.body.items.item.length > 0) {

                        dataList = data;
                        var cnt = (data.response.body.items.item.length < 20 ? data.response.body.items.item.length : 20);
                        if ($("#search").val() != "") {
                            cnt = data.response.body.items.item.length;
                        }

                        for (var i = 0; i < data.response.body.items.item.length; i++) {

                            var lng = data.response.body.items.item[i].mapX;
                            var lat = data.response.body.items.item[i].mapY;

                            setMarker(lat, lng, data.response.body.items.item[i].facltNm, i);

                            if (i < cnt) {

                                var visiable = ""
                                if (i >= 5) {
                                    visiable = "non-visiable"
								}

                                var imgUrl = data.response.body.items.item[i].firstImageUrl == "" ? "/img/no_image.png" : data.response.body.items.item[i].firstImageUrl;

                                list += '<div class="alert alert-info '+ visiable +'" >';
                                list += '    <div class="media">';
                                list += '        <div class="media-left">';
                                list += '        <a href="#">';
                                list += '            <img class="media-object" src="'+ imgUrl +'" style="width: 80px; height: 60px;">';
                                list += '        </a>';
                                list += '        </div>';
                                list += '        <div class="media-body">';
                                list += '        <h4 class="media-heading">' + data.response.body.items.item[i].facltNm + '</h4>';

                                var tel = "";
                                if (data.response.body.items.item[i].tel != "") {
                                    //tel =    ' [Tel:' + data.response.body.items.item[i].tel + ']'
                                }

                                list += '        ' + data.response.body.items.item[i].addr1 + tel ;
                                list += '        </div>';
                                list += '    </div>';
                                list += '</div>';


                            }
                        }

                        for (var i = 0; i < markers.length; i++)
                        {
                            markers[i].setMap(map);
                            naver.maps.Event.addListener(markers[i], 'click', getClickHandler(i));
                        }

                        // 검색은 첫번째 데이터로 이동
                        if ($("#search").val() != "") {
                            var center = new naver.maps.LatLng(data.response.body.items.item[0].mapY, data.response.body.items.item[0].mapX);
                            
                            map.setCenter(center);
                        }


                        if (cnt > 5) {
                            // 더보기 버튼
                            list += '<div id="more">';
                            list += '  <button type="button" class="btn btn-default btn-lg btn-block" onclick="viewMore();">더보기(More)</button>';
                            list += '</div>';

						}

                    }


                    if (list != "") {

                        $("#divCampList").html(list);
                    }


                },
                error: function (data) {
                    //alert("error: " + data.responseText);
                }
            });


        }
    }


    function setMap(lat, lng) {
        var mapOptions = {
            center: new naver.maps.LatLng(lat, lng),
            zoom: 10
        };

        console.log(mapOptions);

        map = new naver.maps.Map('divMap', mapOptions);
	}

    /*
    naver.maps.Event.addListener(map, 'zoom_changed', function() {
        updateMarkers(map, markers);

    });

    naver.maps.Event.addListener(map, 'dragend', function() {
        updateMarkers(map, markers);
    });

    function updateMarkers(map, markers) {

        var mapBounds = map.getBounds();
        var marker, position;

        console.log(mapBounds);
        console.log(marker);
        console.log(position);


        for (var i = 0; i < markers.length; i++) {

            marker = markers[i]
            position = marker.getPosition();

            if (mapBounds.hasLatLng(position)) {
                showMarker(map, marker);
            } else {
                hideMarker(map, marker);
            }
        }
    }

    function showMarker(map, marker) {
        console.log('show')
        if (marker.setMap()) return;
        marker.setMap(map);
    }

    function hideMarker(map, marker) {
        console.log('hide')
        if (!marker.setMap()) return;
        marker.setMap(null);
    }
*/



    function setMarker(lat, lng, facltNm, seq) {
        var marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(lat, lng),
            map: map,
            /*
            icon: {
                url: '/img/camp_icon.png',
                size: new naver.maps.Size(22, 35)
                
            }
            */
        });

        markers.push(marker);


        var infoWindow = new naver.maps.InfoWindow({
            content: '<div style="width:150px;text-align:center;padding:10px;" onclick="closeInfo('+ seq +')"> <b>'+ facltNm +'</b></div>'
        });

        infoWindows.push(infoWindow);

    }

    function closeInfo(seq) {
        infoWindows[seq].close();
	}


    // 해당 마커의 인덱스를 seq라는 클로저 변수로 저장하는 이벤트 핸들러를 반환합니다.
    function getClickHandler(seq) {
        return function (e) {

            var marker = markers[seq],
            infoWindow = infoWindows[seq];

            if (infoWindow.getMap()) {
                infoWindow.close();
            } else {
                infoWindow.open(map, marker);
            }
            
            //console.log(seq);

            setCampDetail(seq);

            var imgHtml = "";
            $("#divImage").show();
            $("#divImage").html("<div style='text-align:center;'><img src='/img/loading.gif'/></div>");

            $.ajax({
                type: "post",
                url: "/home/SearchImage",
                data: "contentId=" + dataList.response.body.items.item[seq].contentId,
                success: function (data) {

                    //$("#divImage").empty();

                    if (data.response != null) {
                        if (data.response.body.items != null) {
                            if (data.response.body.items.item.length > 0) {

                                imgHtml += '<div class="swiper-img">';
                                imgHtml += '<div class="swiper-wrapper">';

                                for (var i = 0; i < data.response.body.items.item.length; i++) {
                                    //console.log(data.response.body.items.item[i]);
                                    imgHtml += '<div class="swiper-slide"><a href="javascript:showImg(\'' + data.response.body.items.item[i].imageUrlOri + '\');"><img src="' + data.response.body.items.item[i].imageUrl + '" style="width:100%; height:300px;" /></a></div>'
                                }

                                imgHtml += '</div>';
                                //imgHtml += '<div class="swiper-pagination"></div>';
                                imgHtml += '</div>';

                                imgHtml += '<hr style="height:5px;"/>';
                            }
                            else {
                                imgHtml = "<img src='/img/no_image.png' />";

                                $("#divImage").hide();

							}

                            $("#divImage").html(imgHtml);
                            swipe();
                        }
                        else {
                            $("#divImage").html("<img src='/img/no_image.png' />");
                            $("#divImage").hide();
                        }

                    }
                    else {
                        $("#divImage").html("<img src='/img/no_image.png' />");
                        $("#divImage").hide();
					}
                    
                },
                error: function (data) {
                    //alert("error: " + data.responseText);
                    $("#divImage").html("<img src='/img/no_image.png' />");
                    $("#divImage").hide();
                }
            });


            getBlogs(seq);
            
        }
    }

    function swipe() {
         const swiper = new Swiper('.swiper-img', {
         // Optional parameters
         //direction: 'vertical',
             slidesPerView: 1,
             loop: false,
             spaceBetween: 30,

             
          
         });

         const swiper_blog = new Swiper('.swiper-blog', {
         // Optional parameters
         //direction: 'vertical',

                    slidesPerView: 1,
             loop: false,
             spaceBetween: 30,
          
        });
	}

    function showImg(url) {
        window.open(url);
        //console.log(url);
    }

    function setCampDetail(seq) {

        //console.log(dataList.response.body.items.item[seq]);


        var title = ""
        title += "<p>■ <b>" + dataList.response.body.items.item[seq].facltNm + "</b></p>"
        title += "<p> - " + dataList.response.body.items.item[seq].addr1 + " " + dataList.response.body.items.item[seq].addr2 + "</p>"
        if (dataList.response.body.items.item[seq].lineIntro != "") {
            title += "<p> - " + dataList.response.body.items.item[seq].lineIntro + "</p>"
        }
        title += "<hr style='height:5px;'/>";
        $("#divTitle").html(title);

        var reserve = "<p>■ <b>예약 문의</b></p>"
        if (dataList.response.body.items.item[seq].tel != "") {
            reserve += "<p> - 전화번호 : <a href='tel:" + dataList.response.body.items.item[seq].tel + "'>" + dataList.response.body.items.item[seq].tel + "</a><br></p>";
        }
        var homepage = dataList.response.body.items.item[seq].homepage;
        if (homepage !="" && dataList.response.body.items.item[seq].homepage.indexOf("http") != 0) {
            homepage = "http://" + homepage;
        }
        if (homepage != "") {
            reserve += "<p> - 홈페이지 : <a href='" + homepage + "' target='_blank'> " + dataList.response.body.items.item[seq].homepage + "</a></p>"
        }
        $("#divReserve").html(reserve);
            
        var detail = '<div>';
        detail += "<p>" + dataList.response.body.items.item[seq].intro + "<br></p>"
        detail += '</div>';
        detail += "<hr style='height:5px;'/>";
        if (dataList.response.body.items.item[seq].intro != "") {
            $("#divDesc").html(detail);
            $("#divDesc").show();
        }
        else {
            $("#divDesc").hide();
		}


        var induty = dataList.response.body.items.item[seq].induty.split(',');

        var info = ''
        info += '<p>■ <b>시설 및 운영정보</b></p>';
        //info += '<p>' + dataList.response.body.items.item[seq].induty + '</p>';
        info += "<p> - 업종 : " + dataList.response.body.items.item[seq].induty + "</a><br></p>";
        info += "<p> - 애완동물 동반 : " + dataList.response.body.items.item[seq].animalCmgCl + "</a><br></p>";
        info += "<p> - 부대시설 : " +  dataList.response.body.items.item[seq].sbrsCl + "</a><br></p>";
        if (dataList.response.body.items.item[seq].sbrsEtc != "") {
            info += "<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * " +  dataList.response.body.items.item[seq].sbrsEtc + "</a><br></p>";
        }

        if (dataList.response.body.items.item[seq].exprnProgrm != "") {
            info += "<p> - 체험프로그램 : " +  dataList.response.body.items.item[seq].exprnProgrm + "</a><br></p>";
        }
        if (dataList.response.body.items.item[seq].clturEvent != "") {
            info += "<p> - 자체문화행사 : " +  dataList.response.body.items.item[seq].clturEvent + "</a><br></p>";
        }
        if (dataList.response.body.items.item[seq].posblFcltyCl != "") {
            info += "<p> - 주변이용 가능시설 : " +  dataList.response.body.items.item[seq].posblFcltyCl + "</a><br></p>";
        }
        
        


        // 업종및 사이트 수
        /*
        var cn1 = Number(dataList.response.body.items.item[seq].gnrlSiteCo);
        var cn2 = Number(dataList.response.body.items.item[seq].autoSiteCo);
        var cn3 = Number(dataList.response.body.items.item[seq].glampSiteCo);
        var cn4 = Number(dataList.response.body.items.item[seq].caravSiteCo);

        var str1 = (cn1 > 0 ? " (" + cn1 + "개)" : "");
        var str2 = (cn2 > 0 ? " (" + cn2 + "개)" : "");
        var str3 = (cn3 > 0 ? " (" + cn3 + "개)" : "");
        var str4 = (cn4 > 0 ? " (" + cn4 + "개)" : "");
        var sum = cn1 + cn2 + cn3 + cn4;
        var sumStr = sum > 0 ? "(사이트 수)" : "";

        for (var i = 0; i < induty.length; i++) {

            if (induty == "일반야영장") 
                info += ' <div class="col-xs-6">일반야영장'+ str1+ '</div>'
            else if (induty == "자동차야영장") 
                info += ' <div class="col-xs-6">자동차야영장'+ str2 +'</div>'
            else if (induty == "글램핑") 
                info += ' <div class="col-xs-6">글램핑'+ str3 +'</div>'
            else if (induty == "카라반") 
                info += ' <div class="col-xs-6">카라반'+ str4 +'</div>'
		}
        */
        info += '</div>'
        
        info += '<hr style="height:5px;"/>';

        $("#divInfo").html(info);

	}

    function getBlogs(seq) {

        var name = dataList.response.body.items.item[seq].facltNm;
        var blog = ''
        

        $.ajax({
                type: "post",
                url: "/home/Blogs",
                data: "query=" + encodeURIComponent(name),
                success: function (data) {
                    //script = data.replace(/<script>(.*)<\/script>/, "$1"); // Remove tags
                    //eval(script); // Execute javascript

                    console.log(data);


                    if (data.items != null && data.items.length > 0) {

                        blog += '<p>■ <b>이용 후기(블로그)</b></p>';
                        blog += '<div class="swiper-blog">';
                        blog += '<div class="swiper-wrapper">';

                        for (var i = 0; i < data.items.length; i++) {
                            
                            blog += ' <div class="swiper-slide">';
                            blog += '   <div style="margin-bottom:5px;"><b>' + data.items[i].title + '</b></div>';
                            blog += '   <a href="' + data.items[i].link + '" target="_blank");">';
                            blog += '     <div>'+ data.items[i].description +'</div>';                           
                            blog += '   </a>';


                            var ymd = data.items[i].postdate.substr(0, 4) + '-' +
                                data.items[i].postdate.substr(4, 2) + '-' +
                                data.items[i].postdate.substr(6, 2);


                            blog += '   <div style="text-align:right;">'+ ymd +'</div>';
                            blog += ' </div>';
                        }
                        blog += '</div>';
                        blog += '</div>';

                        $("#divBlogs").html(blog);
                        swipe();
					}

                },
                error: function (data) {
                    //alert("error: " + data.responseText);
                }
            });
    }

    function viewMore() {
        var tot = $("#divCampList > .non-visiable").length;
        
        if (tot > 0) {
            $("#divCampList > .non-visiable").each(function (index, item) {
                if (index < 5) {
                    $(this).removeClass("non-visiable");
                }
            });
        }

        var tot2 = $("#divCampList > .non-visiable").length;
        
        if (tot2 == 0) $("#more").hide();
	}
    

</script>

    <div id="divSearch" style="margin:0 0 8px 0;text-align:left;">
        <form class="form-inline">
          <div class="form-group">
            <div class="input-group">
              <input type="text" class="form-control" id="search" placeholder="">              
                 <span class="input-group-btn">
                <button class="btn btn-primary" type="button" onclick="javascript:mapSet();">검색</button>
              </span>
            </div>
          </div>
        </form>
    </div>

    <div id="divMap" style="width:100%;height:250px;"></div>


    
    <div id="divCampList" style="margin-top: 25px;"></div>

    <div style="margin-left:10px;">
        <div id="divTitle" style="width:100%;margin-top:15px;"></div>

        <div id="divReserve" style="width:100%;margin-top:15px;"></div>
    
        <div id="divImage" style="width:100%;margin-top:5px;"></div>

        <div id="divDesc" style="width:100%;margin-top:15px;display:none;"></div>
    
        <div id="divInfo" style="width:100%;margin-top:15px;"></div>
    
        <div id="divBlogs" style="width:100%;margin-top:15px;"></div>

        <div id="divBottom" style="width:100%;height:100px;"></div>
    </div>